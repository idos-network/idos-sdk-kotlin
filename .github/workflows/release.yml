name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 0.0.9 or 0.0.9-rc1)'
        required: true
        type: string

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      version: ${{ steps.vars.outputs.version }}
      tag: ${{ steps.vars.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate semver
        uses: matt-usurp/validate-semver@v2
        with:
          version: ${{ inputs.version }}

      - name: Set version variables
        id: vars
        run: |
          VERSION="${{ inputs.version }}"
          TAG="v$VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Check tag doesn't exist
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::error::Tag $TAG already exists"
            exit 1
          fi
          echo "Tag $TAG is available"

  build-and-test:
    name: Build and Test
    needs: validate
    uses: ./.github/workflows/reusable_build_and_test.yml
    with:
      upload-artifacts: true
    secrets:
      MNEMONIC_WORDS: ${{ secrets.MNEMONIC_WORDS }}
      PASSWORD: ${{ secrets.PASSWORD }}

  maestro-tests:
    name: Maestro UI Tests
    needs: build-and-test
    uses: ./.github/workflows/reusable_maestro_tests.yml
    secrets:
      PASSWORD: ${{ secrets.PASSWORD }}

  release:
    name: Release
    needs: [validate, build-and-test, maestro-tests]
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Download Android AAR artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-release-aar
          path: shared/build/outputs/aar/

      - name: Download iOS XCFramework artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-release-xcframework
          path: shared/build/XCFrameworks/release/idos_sdk.xcframework/

      - name: Download Android debug APK
        uses: actions/download-artifact@v4
        with:
          name: android-debug-apk
          path: androidApp/build/outputs/apk/debug/

      - name: Download iOS debug app
        uses: actions/download-artifact@v4
        with:
          name: ios-debug-app
          path: iosApp/build/Build/Products/Debug-iphonesimulator/

      - name: Zip iOS XCFramework for distribution
        run: |
          cd shared/build/XCFrameworks/release
          zip -r idos_sdk.xcframework.zip idos_sdk.xcframework
          shasum -a 256 idos_sdk.xcframework.zip > idos_sdk.xcframework.zip.sha256

      - name: Zip iOS sample app for distribution
        run: |
          cd iosApp/build/Build/Products/Debug-iphonesimulator
          zip -r iosApp-debug.app.zip iosApp.app

      - name: Update version files
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TAG="${{ needs.validate.outputs.tag }}"
          CHECKSUM=$(cat shared/build/XCFrameworks/release/idos_sdk.xcframework.zip.sha256 | awk '{print $1}')

          # Update gradle.properties
          sed -i.bak "s/^VERSION=.*/VERSION=$VERSION/" gradle.properties
          rm gradle.properties.bak

          # Update Package.swift
          sed -i.bak "s/let version = \".*\"/let version = \"$VERSION\"/" Package.swift
          sed -i.bak "s|releases/download/v[^/]*/|releases/download/$TAG/|" Package.swift
          sed -i.bak "s/checksum: \".*\"/checksum: \"$CHECKSUM\"/" Package.swift
          rm Package.swift.bak

          # Update documentation versions
          sed -i.bak "s/idos-sdk-kotlin:[0-9]\+\.[0-9]\+\.[0-9]\+/idos-sdk-kotlin:$VERSION/g" README.md
          sed -i.bak "s/version \`[0-9]\+\.[0-9]\+\.[0-9]\+\`/version \`$VERSION\`/g" README.md
          sed -i.bak "s/from: \"[0-9]\+\.[0-9]\+\.[0-9]\+\"/from: \"$VERSION\"/g" README.md
          sed -i.bak "s/version: [0-9]\+\.[0-9]\+\.[0-9]\+/version: $VERSION/g" PUBLISHING.md
          sed -i.bak "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/v$VERSION/g" PUBLISHING.md
          rm README.md.bak PUBLISHING.md.bak

      - name: Commit version and create tag
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TAG="${{ needs.validate.outputs.tag }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add gradle.properties Package.swift README.md PUBLISHING.md
          git commit -m "Release $TAG [skip ci]"
          git tag "$TAG"
          git push origin main
          git push origin "$TAG"

      - name: Publish to Maven Central
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          ./gradlew publishAndReleaseToMavenCentral --no-configuration-cache --stacktrace --no-daemon

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.tag }}
          name: ${{ needs.validate.outputs.tag }}
          body: |
            ## SDK Artifacts
            - `idos_sdk-release.aar` - Android SDK (for Maven/Gradle)
            - `idos_sdk.xcframework.zip` - iOS SDK (for Swift Package Manager)

            ## Sample Apps (Debug/Demo)
            - `androidApp-debug.apk` - Android sample app (installable on devices/emulators)
            - `iosApp-debug.app.zip` - iOS sample app (for simulator testing)

            Use the sample apps to verify SDK integration and test functionality.
          files: |
            shared/build/outputs/aar/*.aar
            shared/build/XCFrameworks/release/idos_sdk.xcframework.zip
            shared/build/XCFrameworks/release/idos_sdk.xcframework.zip.sha256
            androidApp/build/outputs/apk/debug/androidApp-debug.apk
            iosApp/build/Build/Products/Debug-iphonesimulator/iosApp-debug.app.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
