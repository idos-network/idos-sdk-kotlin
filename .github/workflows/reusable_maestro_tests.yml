name: Maestro UI Tests (Reusable)

on:
  workflow_call:
    secrets:
      PASSWORD:
        required: true

jobs:
  maestro-android:
    name: Maestro Tests (Android)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-debug-apk
          path: ./

      - name: Enable KVM for hardware acceleration
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-34-x86_64

      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: echo "Generated AVD snapshot for caching."

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Run Maestro tests
        uses: reactivecircus/android-emulator-runner@v2
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            ls -la *.apk
            adb install -r androidApp-debug.apk
            maestro test --format junit --output maestro-results-android.xml --debug-output maestro-debug-android --flatten-debug-output --env APP_ID="org.idos.app" --env PASSWORD="$PASSWORD" maestro-flows/

      - name: Upload Maestro debug artifacts (Android)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-debug-android
          path: maestro-debug-android/
          retention-days: 30

      - name: Publish Maestro test results
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: 'maestro-results-android.xml'
          check_name: 'Maestro Tests (Android)'
          require_tests: false

  maestro-ios:
    name: Maestro Tests (iOS)
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download iOS app
        uses: actions/download-artifact@v4
        with:
          name: ios-debug-app
          path: ./

      - name: Set up iOS Simulator
        run: |
          ls -la
          unzip -q iosApp.app.zip
          ls -la iosApp.app || echo "iosApp.app not found"

          # Boot simulator and wait for it to be ready
          xcrun simctl boot "iPhone 16" || true

          # Wait for simulator to fully boot (up to 60 seconds)
          for i in {1..60}; do
            if xcrun simctl bootstatus "iPhone 16" 2>&1 | grep -q "Boot status: Booted"; then
              echo "Simulator booted successfully"
              break
            fi
            echo "Waiting for simulator to boot... ($i/60)"
            sleep 1
          done

          # Install app
          xcrun simctl install booted iosApp.app

          # Give the system a moment to settle
          sleep 5

      - name: Install Maestro
        run: |
          brew tap mobile-dev-inc/tap
          brew install maestro

      - name: Run Maestro tests
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
          MAESTRO_DRIVER_STARTUP_TIMEOUT: 180000
        run: |
          maestro test --format junit --output maestro-results-ios.xml --debug-output maestro-debug-ios --flatten-debug-output --env APP_ID="org.idos.app" --env PASSWORD="$PASSWORD" maestro-flows/

      - name: Upload Maestro debug artifacts (iOS)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-debug-ios
          path: maestro-debug-ios/
          retention-days: 30

      - name: Publish Maestro test results
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: 'maestro-results-ios.xml'
          check_name: 'Maestro Tests (iOS)'
          require_tests: false
