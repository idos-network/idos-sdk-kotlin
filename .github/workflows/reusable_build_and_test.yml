name: Build and Test (Reusable)

on:
  workflow_call:
    inputs:
      upload-artifacts:
        description: 'Whether to upload build artifacts'
        required: false
        type: boolean
        default: false
      retention-days:
        description: 'How long to keep artifacts (days)'
        required: false
        type: number
        default: 30
    secrets:
      MNEMONIC_WORDS:
        required: false
      PASSWORD:
        required: false

jobs:
  build-and-test:
    name: Build and Test All
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for git-versioning plugin to find tags

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Kotlin/Native compiler
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('**/*.gradle.kts', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-konan-

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Create .env for tests from GitHub Secrets
        shell: bash
        env:
          MNEMONIC_WORDS: ${{ secrets.MNEMONIC_WORDS }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          # Write .env used by dotenv-kotlin in tests. Values come from repository secrets.
          cat > .env <<EOF
          MNEMONIC_WORDS=$MNEMONIC_WORDS
          PASSWORD=$PASSWORD
          EOF
          echo ".env created with test credentials"

      - name: Lint and Test
        run: ./gradlew ktlintCheck detekt allTests --stacktrace --no-daemon --no-configuration-cache

      - name: Publish Test Report
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: '**/test-results/**/TEST-*.xml'
          require_tests: false

      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: |
            **/build/reports/detekt/*.html
            **/build/reports/detekt/*.xml
            **/build/reports/ktlint/*.xml
          if-no-files-found: ignore

      - name: Build SDK (AAR + XCFramework)
        run: ./gradlew :shared:assembleRelease :shared:assembleIdos_sdkReleaseXCFramework --stacktrace --no-daemon --no-configuration-cache

      - name: Build sample apps (Android + iOS)
        run: |
          ./gradlew :androidApp:assembleDebug --no-daemon
          cd iosApp && xcodebuild build \
            -scheme iosApp \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            -configuration Debug \
            -derivedDataPath build

      - name: Zip iOS app for artifact upload
        if: ${{ inputs.upload-artifacts }}
        run: |
          cd iosApp/build/Build/Products/Debug-iphonesimulator
          zip -r iosApp.app.zip iosApp.app
          ls -lh iosApp.app.zip

      - name: Upload Android AAR artifacts
        if: ${{ inputs.upload-artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: android-release-aar
          path: shared/build/outputs/aar/*.aar
          if-no-files-found: error

      - name: Upload iOS XCFramework artifacts
        if: ${{ inputs.upload-artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-xcframework
          path: shared/build/XCFrameworks/release/idos_sdk.xcframework/**
          if-no-files-found: error

      - name: Upload Android APK
        if: ${{ inputs.upload-artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: androidApp/build/outputs/apk/debug/androidApp-debug.apk
          retention-days: ${{ inputs.retention-days }}
          if-no-files-found: error

      - name: Upload iOS app
        if: ${{ inputs.upload-artifacts }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-debug-app
          path: iosApp/build/Build/Products/Debug-iphonesimulator/iosApp.app.zip
          retention-days: ${{ inputs.retention-days }}
          if-no-files-found: error
